name: main2

on:
  workflow_dispatch:

# üî• TRAVA DE SEGURAN√áA: Garante fila √∫nica sem atropelar processos
concurrency:
  group: shopee-handover-queue
  cancel-in-progress: false # Falso para que o novo ESPERE o antigo terminar em vez de cancel√°-lo

jobs:
  run-script:
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Aumentado para acomodar o tempo de fila e download

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4 # Atualizado para v4 (Evita erro da imagem 979f12)

      - name: Instalar Python
        uses: actions/setup-python@v5 # Atualizado para v5
        with:
          python-version: '3.10'
          cache: 'pip' # Acelera instala√ß√µes futuras

      - name: Restaurar hxh.json a partir do segredo
        run: |
          if [[ -z "$GCP_JSON_BASE64" ]]; then
            echo "‚ùå Erro: Segredo GCP_JSON_BASE64 est√° vazio!"
            exit 1
          fi
          echo "$GCP_JSON_BASE64" | base64 -d > hxh.json
          echo "‚úÖ hxh.json criado com sucesso."
        shell: bash
        env:
          GCP_JSON_BASE64: ${{ secrets.GCP_JSON_BASE64 }}

      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps # Necess√°rio para garantir que o Chromium rode no Linux

      - name: Executar o script
        # Define resolu√ß√£o est√°vel para evitar erros de renderiza√ß√£o
        run: xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" python main2.py

      - name: Upload Debug Screenshot (Se falhar)
        if: failure()
        uses: actions/upload-artifact@v4 # Atualizado para v4 (Imagem 979f12)
        with:
          name: erro-processamento
          path: debug_error.png
